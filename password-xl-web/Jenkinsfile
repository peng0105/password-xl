pipeline {
    agent { label 'nodejs-24' }

    environment {
        IMAGE_NAME    = "harbor.huangyp.cn/password-xl/password-xl-web"
        YARN_REGISTRY = "https://nexus.huangyp.cn/repository/npm-group/"

    }

    options {
        buildDiscarder(logRotator(numToKeepStr: '10', artifactNumToKeepStr: '5'))
        timeout(time: 30, unit: 'MINUTES')
    }

    stages {
        stage('Install & Build') {
            steps {
                container('node') {
                    sh '''
                    set -euo pipefail
                    yarn config set registry ${YARN_REGISTRY}

                    cd password-xl-web

                    echo "å®‰è£…ä¾èµ–..."
                    yarn install

                    echo "å¼€å§‹æ„å»º..."
                    yarn build
                    '''
                }
            }
        }

        stage('Build & Push Image (BuildKit)') {
          steps {
            container('buildkit') {
              sh '''
              set -e

              mkdir -p /root/.docker
              cp /root/.dockerconfigjson/.dockerconfigjson /root/.docker/config.json

              echo "æ„å»ºå¹¶æ¨é€é•œåƒ..."
              buildctl-daemonless.sh build \
                --frontend dockerfile.v0 \
                --local context="${WORKSPACE}/password-xl-web" \
                --local dockerfile="${WORKSPACE}/password-xl-web" \
                --opt filename=Dockerfile \
                --output type=image,\\"name=${IMAGE_NAME}:${BUILD_NUMBER},${IMAGE_NAME}:latest\\",push=true
              '''
            }
          }
        }

        stage('Deploy to Kubernetes') {
            steps {
                container('kubectl') {
                    sh '''#!/bin/bash
                    set -euo pipefail

                    echo "ğŸ” ä½¿ç”¨å½“å‰æ„å»ºé•œåƒæ›´æ–° Deploymentï¼Œè§¦å‘æ»šåŠ¨å‘å¸ƒ..."
                    kubectl set image deployment/password-xl-web \
                      password-xl-web=${IMAGE_NAME}:${BUILD_NUMBER} \
                      -n "password-xl"

                    echo "â³ ç­‰å¾… Deployment å®Œæˆæ»šåŠ¨æ›´æ–°..."
                    kubectl rollout status deployment/password-xl-web -n "password-xl" --timeout=270s

                    echo "âœ… éƒ¨ç½²å®Œæˆ: password-xl-web"
                    '''
                }
            }
        }
    }
}
