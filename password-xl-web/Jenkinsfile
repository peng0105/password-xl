pipeline {
    agent { label 'nodejs-24' }

    environment {
        PROJECT_NAME    = "huangyp-todo-web"
        IMAGE_NAME    = "harbor.huangyp.cn/huangyp/password-xl-web"
        YARN_REGISTRY = "https://nexus.huangyp.cn/repository/npm-group/"
    }

    options {
        buildDiscarder(logRotator(numToKeepStr: '10', artifactNumToKeepStr: '5'))
        timeout(time: 30, unit: 'MINUTES')
    }

    stages {
        stage('Install & Build') {
            steps {
                container('node') {
                    sh '''
                    set -e
                    yarn config set registry ${YARN_REGISTRY}

                    cd password-xl-web

                    echo "安装依赖..."
                    yarn install

                    echo "开始构建..."
                    yarn build
                    '''
                }
            }
        }

        stage('Build & Push Image (BuildKit)') {
          steps {
            container('buildkit') {
              sh '''
              set -e

              mkdir -p /root/.docker
              cp /root/.dockerconfigjson/.dockerconfigjson /root/.docker/config.json

              echo "构建并推送镜像..."
              buildctl-daemonless.sh build \
                --frontend dockerfile.v0 \
                --local context="${WORKSPACE}/password-xl-web" \
                --local dockerfile="${WORKSPACE}/password-xl-web" \
                --opt filename=Dockerfile \
                --output type=image,\\"name=${IMAGE_NAME}:${BUILD_NUMBER},${IMAGE_NAME}:latest\\",push=true
              '''
            }
          }
        }
    }
}
