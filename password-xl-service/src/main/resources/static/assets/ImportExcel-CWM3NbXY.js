import{k as ne,l as ie,m as de,c as ue,x as ce,e as fe,f as pe,E as c,b as me}from"./element-plus-DNQbW8zx.js";import{E as we}from"./exceljs-B9bSeXl2.js";import{u as ve,a as ge,p as he,B as xe,d as be,R as _e,U as ye,P as q,i as ke,c as G,_ as Ee}from"./index-DzZIArpw.js";import{a4 as Ce}from"./vendor-BvEI7uIN.js";import{d as Te,r as y,c as L,o as p,a as V,D as n,v as i,u as g,n as C,B as T,C as P,F as Y,a1 as K,j as Pe,M as Se}from"./@vue-PmY8Mkr0.js";import"./@element-plus-CuK1irWX.js";import"./ali-oss-CN0NZiD5.js";import"./cos-js-sdk-v5-WX9VGj_f.js";const De=Te({__name:"ImportExcel",setup(Re,{expose:Q}){const u=ve(),X=ge(),k=y(),m=y(),h=y(!1),w=y([]),v=y([]),Z=async()=>{w.value=[],v.value=[],k.value.value="",k.value.click()},ee=()=>{let s=k.value.files;if(!s.length)return;const t=new FileReader;t.onload=()=>{const e=Ce.Buffer.from(t.result);try{te(e)}catch{c.error("密码导入失败")}},t.onerror=e=>{c.error("读取文件失败")},t.readAsArrayBuffer(s[0])},E=s=>{s?.value&&typeof s.value=="object"&&"text"in s.value&&(s.value=s.value.text)},te=async s=>{const t=new we.Workbook;await t.xlsx.load(s);const e=t.getWorksheet(1);if(!e){c.error("导入失败，没有找到Sheet页");return}let l=e.getRow(1);if(!l){c.error("导入失败，文件中未找到密码数据");return}const a=l.values;if(!a||e.rowCount<2){c.error("导入失败，文件中未找到密码数据");return}const o={id:a.indexOf("id"),title:a.indexOf("名称"),address:a.indexOf("地址"),username:a.indexOf("用户名"),password:a.indexOf("密码"),remark:a.indexOf("备注"),addTime:a.indexOf("创建时间"),favorite:a.indexOf("收藏"),labels:a.indexOf("标签"),customFields:a.indexOf("自定义信息")};if(!o.title){c.error("导入失败，未找到密码名称列");return}for(let x=2;x<=e.rowCount;x++){const d=e.getRow(x);let b=d.getCell(o.title);if(!b)continue;let r=o.id!==-1?d.getCell(o.id):null,f=o.address!==-1?d.getCell(o.address):null,S=o.username!==-1?d.getCell(o.username):null,D=o.password!==-1?d.getCell(o.password):null,R=o.remark!==-1?d.getCell(o.remark):null,F=o.addTime!==-1?d.getCell(o.addTime):null,M=o.labels!==-1?d.getCell(o.labels):null,U=o.favorite!==-1?d.getCell(o.favorite):null,O=o.customFields!==-1?d.getCell(o.customFields):null;E(f),E(S),E(D),E(R);let W=U&&U.value==="是",J=[];if(M&&M.value){let _=_e(M.value);N(v.value,_),A(_,J)}let re=F&&F.value?ye(F.value,"YYYY-MM-DD HH:mm:ss"):new Date;const $={id:r?r.value:ke(),title:b?b.value:"",address:f?f.value:"",username:S?S.value:"",password:D?D.value:"",remark:R?R.value:"",addTime:re.getTime(),updateTime:Date.now(),deleteTime:0,favoriteTime:W?Date.now():0,favorite:W,customFields:[],labels:J,status:q.NORMAL,bgColor:""};if(O&&O.value){let _=O.value.split(`\r
`);for(let I=0;I<_.length;I++){let B=_[I].split("：");$.customFields.push({key:B[0],val:B.length>1?B[1]:"",hidden:!1})}}w.value.push($)}w.value.length||v.value.length?(h.value=!0,await Se(()=>{m.value.toggleAllSelection()})):c.warning("没有可导入的密码")},A=(s,t=[])=>(s.forEach(e=>{!e.children||e.children.length===0?t.push(e.id):A(e.children,t)}),t),N=(s,t)=>{for(let e=0;e<t.length;e++){let l=t[e],a=s.find(o=>o.name===l.name);if(!a){s.push(l);continue}l.id=a.id,N(a.children,l.children)}},le=()=>{if(!m.value.getSelectionRows().length){me.warning("请选择要导入的密码");return}X.verifyPasswordRef.getAndVerify(t=>u.passwordManager.verifyPassword(t)).then(()=>{se()})},se=()=>{try{u.loading("正在导入...");const t=m.value.getSelectionRows().map(l=>l.id),e=w.value.filter(l=>t.includes(l.id));ae(u.allPasswordArray,e),z(u.labelArray,v.value),u.passwordManager.syncStoreData(),h.value=!1,w.value=[],v.value=[],u.unloading(),c.success("导入成功")}catch{u.unloading(),c.error("导入失败")}},ae=(s,t)=>{t.forEach(e=>{const l=s.find(a=>G(a,e));if(l){if(l.status=q.NORMAL,e.labels){const a=new Set(l.labels);e.labels.forEach(o=>{a.has(o)||l.labels.push(o)})}}else s.push(e)})},z=(s,t)=>{const e=new Map(s.map(l=>[l.name,l]));t.forEach(l=>{const a=e.get(l.name);a?(oe(u.allPasswordArray,l.id,a.id),z(a.children,l.children)):(s.push(l),e.set(l.name,l))})},oe=(s,t,e)=>{s.forEach(l=>{l.labels=l.labels.map(a=>a===t?e:a)})},H=s=>!u.passwordArray.find(t=>G(t,s)),j=()=>m.value?!m.value.getSelectionRows().length:!0;return Q({importExcel:Z}),(s,t)=>{const e=ie,l=de,a=ue,o=ce,x=ne,d=fe,b=pe;return p(),L(Y,null,[V("input",{ref_key:"fileInput",ref:k,accept:".xlsx",style:{display:"none"},type:"file",onChange:t[0]||(t[0]=r=>ee())},null,544),n(b,{modelValue:g(h),"onUpdate:modelValue":t[1]||(t[1]=r=>Pe(h)?h.value=r:null),width:["xs","sm","md"].includes(g(be)().value)?"95%":"80%",title:"导入信息确认",top:"10vh"},{footer:i(()=>[n(l,{disabled:!j(),content:"请选择要导入的密码",placement:"top"},{default:i(()=>[n(d,{disabled:j(),type:"primary",onClick:le},{default:i(()=>[...t[4]||(t[4]=[T("确认导入",-1)])]),_:1},8,["disabled"])]),_:1},8,["disabled"])]),default:i(()=>[n(x,{ref_key:"passwordTableRef",ref:m,data:g(w),height:"65vh"},{default:i(()=>[n(e,{selectable:H,type:"selection",width:"55"}),n(e,{width:"55"},{default:i(r=>[H(r.row)?(p(),C(l,{key:0,content:"可导入",placement:"top"},{default:i(()=>[...t[2]||(t[2]=[V("span",{class:"iconfont icon-info",style:{color:"#409EFF","font-size":"16px"}},null,-1)])]),_:1})):(p(),C(l,{key:1,content:"已存在密码不可导入",placement:"top"},{default:i(()=>[...t[3]||(t[3]=[V("span",{class:"iconfont icon-info",style:{color:"#ff9600","font-size":"16px"}},null,-1)])]),_:1}))]),_:1}),n(e,{label:"名称","min-width":"100px",prop:"title"}),n(e,{label:"地址","min-width":"150px",prop:"address"}),n(e,{label:"用户名","min-width":"100px",prop:"username"}),n(e,{label:"密码",prop:"password",width:"180px"},{default:i(r=>[n(a,{"line-clamp":"3",truncated:""},{default:i(()=>[T(P(r.row.password),1)]),_:2},1024)]),_:1}),n(e,{formatter:r=>g(he)(r.addTime,"YYYY-MM-DD HH:mm"),label:"创建时间","min-width":"150px",prop:"addTime"},null,8,["formatter"]),n(e,{label:"备注","min-width":"100px",prop:"remark"}),n(e,{label:"标签","min-width":"150px",prop:"labels"},{default:i(r=>[(p(!0),L(Y,null,K(g(xe)(r.row,g(v)),f=>(p(),C(o,{class:"table-label"},{default:i(()=>[T(P(f.name),1)]),_:2},1024))),256))]),_:1}),n(e,{label:"自定义信息","min-width":"150px",prop:"customFields"},{default:i(r=>[(p(!0),L(Y,null,K(r.row.customFields,f=>(p(),C(o,{class:"table-label"},{default:i(()=>[T(P(f.key)+"："+P(f.val),1)]),_:2},1024))),256))]),_:1})]),_:1},8,["data"])]),_:1},8,["modelValue","width"])],64)}}}),Ae=Ee(De,[["__scopeId","data-v-f44118c9"]]);export{Ae as default};
