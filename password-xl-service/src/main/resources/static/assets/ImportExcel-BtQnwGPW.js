import{k as re,l as ne,P as ie,c as de,w as ue,e as ce,f as fe,E as f,b as pe}from"./element-plus-C8kBqzPU.js";import{E as me}from"./exceljs-B9bSeXl2.js";import{u as we,a as ve,p as be,B as ge,d as he,R as xe,U as _e,P as $,i as ye,c as q,_ as ke}from"./index-DDbEbXNX.js";import{a4 as Ee}from"./vendor-BvEI7uIN.js";import{d as Te,r as T,c as B,o as p,a as L,D as n,v as i,u as x,n as P,B as S,C as D,F as V,a1 as G,j as Ce,M as Pe}from"./@vue-PmY8Mkr0.js";import"./@element-plus-CuK1irWX.js";import"./ali-oss-CN0NZiD5.js";import"./cos-js-sdk-v5-WX9VGj_f.js";const Se=Te({__name:"ImportExcel",setup(De,{expose:K}){const c=we(),Q=ve(),C=T(),m=T(),_=T(!1),w=T([]),v=T([]),X=async()=>{w.value=[],v.value=[],C.value.value="",C.value.click()},Z=()=>{let o=C.value.files;if(!o.length)return;const t=new FileReader;t.onload=()=>{const e=Ee.Buffer.from(t.result);try{ee(e)}catch{f.error("密码导入失败")}},t.onerror=e=>{f.error("读取文件失败")},t.readAsArrayBuffer(o[0])},ee=async o=>{const t=new me.Workbook;await t.xlsx.load(o);const e=t.getWorksheet(1);if(!e){f.error("导入失败，没有找到Sheet页");return}let l=e.getRow(1);if(!l){f.error("导入失败，文件中未找到密码数据");return}const a=l.values;if(!a||e.rowCount<2){f.error("导入失败，文件中未找到密码数据");return}const s={id:a.indexOf("id"),title:a.indexOf("名称"),address:a.indexOf("地址"),username:a.indexOf("用户名"),password:a.indexOf("密码"),remark:a.indexOf("备注"),addTime:a.indexOf("创建时间"),favorite:a.indexOf("收藏"),labels:a.indexOf("标签"),customFields:a.indexOf("自定义信息")};if(!s.title){f.error("导入失败，未找到密码名称列");return}for(let y=2;y<=e.rowCount;y++){const d=e.getRow(y);let k=d.getCell(s.title);if(!k)continue;let r=s.id!==-1?d.getCell(s.id):null,u=s.address!==-1?d.getCell(s.address):null,b=s.username!==-1?d.getCell(s.username):null,g=s.password!==-1?d.getCell(s.password):null,h=s.remark!==-1?d.getCell(s.remark):null,R=s.addTime!==-1?d.getCell(s.addTime):null,F=s.labels!==-1?d.getCell(s.labels):null,z=s.favorite!==-1?d.getCell(s.favorite):null,M=s.customFields!==-1?d.getCell(s.customFields):null;u&&typeof u.value=="object"&&(u.value=u.value.text),b&&typeof b.value=="object"&&(b.value=b.value.text),g&&typeof g.value=="object"&&(g.value=g.value.text),h&&typeof h.value=="object"&&(h.value=h.value.text);let U=z&&z.value==="是",W=[];if(F&&F.value){let E=xe(F.value);A(v.value,E),Y(E,W)}let oe=R&&R.value?_e(R.value,"YYYY-MM-DD HH:mm:ss"):new Date;const J={id:r?r.value:ye(),title:k?k.value:"",address:u?u.value:"",username:b?b.value:"",password:g?g.value:"",remark:h?h.value:"",addTime:oe.getTime(),updateTime:Date.now(),deleteTime:0,favoriteTime:U?Date.now():0,favorite:U,customFields:[],labels:W,status:$.NORMAL,bgColor:""};if(M&&M.value){let E=M.value.split(`\r
`);for(let O=0;O<E.length;O++){let I=E[O].split("：");J.customFields.push({key:I[0],val:I.length>1?I[1]:"",hidden:!1})}}w.value.push(J)}w.value.length||v.value.length?(_.value=!0,await Pe(()=>{m.value.toggleAllSelection()})):f.warning("没有可导入的密码")},Y=(o,t=[])=>(o.forEach(e=>{!e.children||e.children.length===0?t.push(e.id):Y(e.children,t)}),t),A=(o,t)=>{for(let e=0;e<t.length;e++){let l=t[e],a=o.find(s=>s.name===l.name);if(!a){o.push(l);continue}l.id=a.id,A(a.children,l.children)}},te=()=>{if(!m.value.getSelectionRows().length){pe.warning("请选择要导入的密码");return}Q.verifyPasswordRef.getAndVerify(t=>c.passwordManager.verifyPassword(t)).then(()=>{le()})},le=()=>{try{c.loading("正在导入...");const t=m.value.getSelectionRows().map(l=>l.id),e=w.value.filter(l=>t.includes(l.id));ae(c.allPasswordArray,e),N(c.labelArray,v.value),c.passwordManager.syncStoreData(),_.value=!1,w.value=[],v.value=[],c.unloading(),f.success("导入成功")}catch{c.unloading(),f.error("导入失败")}},ae=(o,t)=>{t.forEach(e=>{const l=o.find(a=>q(a,e));if(l){if(l.status=$.NORMAL,e.labels){const a=new Set(l.labels);e.labels.forEach(s=>{a.has(s)||l.labels.push(s)})}}else o.push(e)})},N=(o,t)=>{const e=new Map(o.map(l=>[l.name,l]));t.forEach(l=>{const a=e.get(l.name);a?(se(c.allPasswordArray,l.id,a.id),N(a.children,l.children)):(o.push(l),e.set(l.name,l))})},se=(o,t,e)=>{o.forEach(l=>{l.labels=l.labels.map(a=>a===t?e:a)})},j=o=>!c.passwordArray.find(t=>q(t,o)),H=()=>m.value?!m.value.getSelectionRows().length:!0;return K({importExcel:X}),(o,t)=>{const e=ne,l=ie,a=de,s=ue,y=re,d=ce,k=fe;return p(),B(V,null,[L("input",{ref_key:"fileInput",ref:C,accept:".xlsx",style:{display:"none"},type:"file",onChange:t[0]||(t[0]=r=>Z())},null,544),n(k,{modelValue:x(_),"onUpdate:modelValue":t[1]||(t[1]=r=>Ce(_)?_.value=r:null),width:["xs","sm","md"].includes(x(he)().value)?"95%":"80%",title:"导入信息确认",top:"10vh"},{footer:i(()=>[n(l,{disabled:!H(),content:"请选择要导入的密码",placement:"top"},{default:i(()=>[n(d,{disabled:H(),type:"primary",onClick:te},{default:i(()=>[...t[4]||(t[4]=[S("确认导入",-1)])]),_:1},8,["disabled"])]),_:1},8,["disabled"])]),default:i(()=>[n(y,{ref_key:"passwordTableRef",ref:m,data:x(w),height:"65vh"},{default:i(()=>[n(e,{selectable:j,type:"selection",width:"55"}),n(e,{width:"55"},{default:i(r=>[j(r.row)?(p(),P(l,{key:0,content:"可导入",placement:"top"},{default:i(()=>[...t[2]||(t[2]=[L("span",{class:"iconfont icon-info",style:{color:"#409EFF","font-size":"16px"}},null,-1)])]),_:1})):(p(),P(l,{key:1,content:"已存在密码不可导入",placement:"top"},{default:i(()=>[...t[3]||(t[3]=[L("span",{class:"iconfont icon-info",style:{color:"#ff9600","font-size":"16px"}},null,-1)])]),_:1}))]),_:1}),n(e,{label:"名称","min-width":"100px",prop:"title"}),n(e,{label:"地址","min-width":"150px",prop:"address"}),n(e,{label:"用户名","min-width":"100px",prop:"username"}),n(e,{label:"密码",prop:"password",width:"180px"},{default:i(r=>[n(a,{"line-clamp":"3",truncated:""},{default:i(()=>[S(D(r.row.password),1)]),_:2},1024)]),_:1}),n(e,{formatter:r=>x(be)(r.addTime,"YYYY-MM-DD HH:mm"),label:"创建时间","min-width":"150px",prop:"addTime"},null,8,["formatter"]),n(e,{label:"备注","min-width":"100px",prop:"remark"}),n(e,{label:"标签","min-width":"150px",prop:"labels"},{default:i(r=>[(p(!0),B(V,null,G(x(ge)(r.row,x(v)),u=>(p(),P(s,{class:"table-label"},{default:i(()=>[S(D(u.name),1)]),_:2},1024))),256))]),_:1}),n(e,{label:"自定义信息","min-width":"150px",prop:"customFields"},{default:i(r=>[(p(!0),B(V,null,G(r.row.customFields,u=>(p(),P(s,{class:"table-label"},{default:i(()=>[S(D(u.key)+"："+D(u.val),1)]),_:2},1024))),256))]),_:1})]),_:1},8,["data"])]),_:1},8,["modelValue","width"])],64)}}}),Ye=ke(Se,[["__scopeId","data-v-69209ebb"]]);export{Ye as default};
