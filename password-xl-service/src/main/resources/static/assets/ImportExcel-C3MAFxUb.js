import{o as re,p as ne,P as ie,c as de,w as ue,e as ce,f as fe,E as f,b as pe}from"./element-plus-DUvDCZNl.js";import{E as me}from"./exceljs-B9bSeXl2.js";import{u as we,a as ve,k as ge,w as be,d as he,K as xe,L as _e,r as U,N as ye,O as $,_ as ke}from"./index-I1pS37Sy.js";import{a4 as Ee}from"./vendor-BvEI7uIN.js";import{d as Te,r as T,c as L,o as p,a as V,D as n,v as i,u as x,n as P,B as S,C as D,F as B,a1 as q,j as Ce,M as Pe}from"./@vue-PmY8Mkr0.js";import"./@element-plus-CuK1irWX.js";import"./ali-oss-CN0NZiD5.js";import"./cos-js-sdk-v5-WX9VGj_f.js";const Se=Te({__name:"ImportExcel",setup(De,{expose:G}){const c=we(),Q=ve(),C=T(),m=T(),_=T(!1),w=T([]),v=T([]),X=async()=>{w.value=[],v.value=[],C.value.value="",C.value.click()},Z=()=>{let o=C.value.files;if(!o.length)return;const t=new FileReader;t.onload=()=>{const e=Ee.Buffer.from(t.result);try{ee(e)}catch{f.error("密码导入失败")}},t.onerror=e=>{f.error("读取文件失败")},t.readAsArrayBuffer(o[0])},ee=async o=>{const t=new me.Workbook;await t.xlsx.load(o);const e=t.getWorksheet(1);if(!e){f.error("导入失败，没有找到Sheet页");return}let l=e.getRow(1);if(!l){f.error("导入失败，文件中未找到密码数据");return}const a=l.values;if(!a||e.rowCount<2){f.error("导入失败，文件中未找到密码数据");return}const s={id:a.indexOf("id"),title:a.indexOf("名称"),address:a.indexOf("地址"),username:a.indexOf("用户名"),password:a.indexOf("密码"),remark:a.indexOf("备注"),addTime:a.indexOf("创建时间"),favorite:a.indexOf("收藏"),labels:a.indexOf("标签"),customFields:a.indexOf("自定义信息")};if(!s.title){f.error("导入失败，未找到密码名称列");return}for(let y=2;y<=e.rowCount;y++){const d=e.getRow(y);let k=d.getCell(s.title);if(!k)continue;let r=s.id!==-1?d.getCell(s.id):null,u=s.address!==-1?d.getCell(s.address):null,g=s.username!==-1?d.getCell(s.username):null,b=s.password!==-1?d.getCell(s.password):null,h=s.remark!==-1?d.getCell(s.remark):null,F=s.addTime!==-1?d.getCell(s.addTime):null,O=s.labels!==-1?d.getCell(s.labels):null,z=s.favorite!==-1?d.getCell(s.favorite):null,R=s.customFields!==-1?d.getCell(s.customFields):null;u&&typeof u.value=="object"&&(u.value=u.value.text),g&&typeof g.value=="object"&&(g.value=g.value.text),b&&typeof b.value=="object"&&(b.value=b.value.text),h&&typeof h.value=="object"&&(h.value=h.value.text);let W=z&&z.value==="是",J=[];if(O&&O.value){let E=xe(O.value);Y(v.value,E),N(E,J)}let oe=F&&F.value?_e(F.value,"YYYY-MM-DD HH:mm:ss"):new Date;const K={id:r?r.value:ye(),title:k?k.value:"",address:u?u.value:"",username:g?g.value:"",password:b?b.value:"",remark:h?h.value:"",addTime:oe.getTime(),updateTime:Date.now(),deleteTime:0,favoriteTime:W?Date.now():0,favorite:W,customFields:[],labels:J,status:U.NORMAL,bgColor:""};if(R&&R.value){let E=R.value.split(`\r
`);for(let M=0;M<E.length;M++){let I=E[M].split("：");K.customFields.push({key:I[0],val:I.length>1?I[1]:""})}}w.value.push(K)}w.value.length||v.value.length?(_.value=!0,await Pe(()=>{m.value.toggleAllSelection()})):f.warning("没有可导入的密码")},N=(o,t=[])=>(o.forEach(e=>{!e.children||e.children.length===0?t.push(e.id):N(e.children,t)}),t),Y=(o,t)=>{for(let e=0;e<t.length;e++){let l=t[e],a=o.find(s=>s.name===l.name);if(!a){o.push(l);continue}l.id=a.id,Y(a.children,l.children)}},te=()=>{if(!m.value.getSelectionRows().length){pe.warning("请选择要导入的密码");return}Q.verifyPasswordRef.getAndVerify(t=>c.passwordManager.verifyPassword(t)).then(()=>{le()})},le=()=>{try{c.loading("正在导入...");const t=m.value.getSelectionRows().map(l=>l.id),e=w.value.filter(l=>t.includes(l.id));ae(c.allPasswordArray,e),A(c.labelArray,v.value),c.passwordManager.syncStoreData(),_.value=!1,w.value=[],v.value=[],c.unloading(),f.success("导入成功")}catch{c.unloading(),f.error("导入失败")}},ae=(o,t)=>{t.forEach(e=>{const l=o.find(a=>$(a,e));if(l){if(l.status=U.NORMAL,e.labels){const a=new Set(l.labels);e.labels.forEach(s=>{a.has(s)||l.labels.push(s)})}}else o.push(e)})},A=(o,t)=>{const e=new Map(o.map(l=>[l.name,l]));t.forEach(l=>{const a=e.get(l.name);a?(se(c.allPasswordArray,l.id,a.id),A(a.children,l.children)):(o.push(l),e.set(l.name,l))})},se=(o,t,e)=>{o.forEach(l=>{l.labels=l.labels.map(a=>a===t?e:a)})},j=o=>!c.passwordArray.find(t=>$(t,o)),H=()=>m.value?!m.value.getSelectionRows().length:!0;return G({importExcel:X}),(o,t)=>{const e=ne,l=ie,a=de,s=ue,y=re,d=ce,k=fe;return p(),L(B,null,[V("input",{ref_key:"fileInput",ref:C,accept:".xlsx",style:{display:"none"},type:"file",onChange:t[0]||(t[0]=r=>Z())},null,544),n(k,{modelValue:x(_),"onUpdate:modelValue":t[1]||(t[1]=r=>Ce(_)?_.value=r:null),width:["xs","sm","md"].includes(x(he)().value)?"95%":"80%",title:"导入信息确认",top:"10vh"},{footer:i(()=>[n(l,{disabled:!H(),content:"请选择要导入的密码",placement:"top"},{default:i(()=>[n(d,{disabled:H(),type:"primary",onClick:te},{default:i(()=>[...t[4]||(t[4]=[S("确认导入",-1)])]),_:1},8,["disabled"])]),_:1},8,["disabled"])]),default:i(()=>[n(y,{ref_key:"passwordTableRef",ref:m,data:x(w),height:"65vh"},{default:i(()=>[n(e,{selectable:j,type:"selection",width:"55"}),n(e,{width:"55"},{default:i(r=>[j(r.row)?(p(),P(l,{key:0,content:"可导入",placement:"top"},{default:i(()=>[...t[2]||(t[2]=[V("span",{class:"iconfont icon-info",style:{color:"#409EFF","font-size":"16px"}},null,-1)])]),_:1})):(p(),P(l,{key:1,content:"已存在密码不可导入",placement:"top"},{default:i(()=>[...t[3]||(t[3]=[V("span",{class:"iconfont icon-info",style:{color:"#ff9600","font-size":"16px"}},null,-1)])]),_:1}))]),_:1}),n(e,{label:"名称","min-width":"100px",prop:"title"}),n(e,{label:"地址","min-width":"150px",prop:"address"}),n(e,{label:"用户名","min-width":"100px",prop:"username"}),n(e,{label:"密码",prop:"password",width:"180px"},{default:i(r=>[n(a,{"line-clamp":"3",truncated:""},{default:i(()=>[S(D(r.row.password),1)]),_:2},1024)]),_:1}),n(e,{formatter:r=>x(ge)(r.addTime,"YYYY-MM-DD HH:mm"),label:"创建时间","min-width":"150px",prop:"addTime"},null,8,["formatter"]),n(e,{label:"备注","min-width":"100px",prop:"remark"}),n(e,{label:"标签","min-width":"150px",prop:"labels"},{default:i(r=>[(p(!0),L(B,null,q(x(be)(r.row,x(v)),u=>(p(),P(s,{class:"table-label"},{default:i(()=>[S(D(u.name),1)]),_:2},1024))),256))]),_:1}),n(e,{label:"自定义信息","min-width":"150px",prop:"customFields"},{default:i(r=>[(p(!0),L(B,null,q(r.row.customFields,u=>(p(),P(s,{class:"table-label"},{default:i(()=>[S(D(u.key)+"："+D(u.val),1)]),_:2},1024))),256))]),_:1})]),_:1},8,["data"])]),_:1},8,["modelValue","width"])],64)}}}),Ne=ke(Se,[["__scopeId","data-v-1a8a4730"]]);export{Ne as default};
