import{o as ne,p as re,P as ie,c as ce,w as de,e as ue,f as fe,E as f,b as pe}from"./element-plus-DfJ8pmrs.js";import{E as me}from"./exceljs-eb77zzzs.js";import{u as we,a as ge,k as ve,w as xe,d as he,K as be,L as _e,r as U,N as ye,O as $,_ as ke}from"./index-DZ5-n0Cs.js";import{a4 as Ee}from"./vendor-B4nIbczL.js";import{d as Ce,r as C,c as L,o as w,a as V,D as r,v as i,u as _,n as P,B as S,C as D,F as B,a1 as q,j as Te,M as Pe}from"./@vue-BhCi5Yj9.js";import"./@element-plus-C1_C3qTM.js";import"./ali-oss-B_Q55M9i.js";import"./cos-js-sdk-v5-B8_2Tx6c.js";const Se=Ce({__name:"ImportExcel",setup(De,{expose:G}){const u=we(),Q=ge(),T=C(),g=C(),y=C(!1),m=C([]),p=C([]),X=async()=>{console.log("进入导入excel"),m.value=[],p.value=[],T.value.value="",T.value.click()},Z=()=>{let a=T.value.files;if(console.log("导入excel,文件选择器选择了文件：",a.length),!a.length)return;const l=new FileReader;l.onload=()=>{console.log("导入excel,文件读取完成");const e=Ee.Buffer.from(l.result);try{ee(e)}catch(t){console.error("导入excel 导入错误",t),f.error("密码导入失败")}},l.onerror=e=>{console.error("导入excel 读取错误",e),f.error("读取文件失败")},l.readAsArrayBuffer(a[0])},ee=async a=>{console.log("导入excel 解析excel");const l=new me.Workbook;await l.xlsx.load(a);const e=l.getWorksheet(1);if(!e){console.log("导入excel 导入失败，没有找到Sheet页"),f.error("导入失败，没有找到Sheet页");return}let t=e.getRow(1);if(!t){console.log("导入excel 导入失败，文件中未找到密码数据"),f.error("导入失败，文件中未找到密码数据");return}const o=t.values;if(console.log("first row values:",o),!o||e.rowCount<2){console.log("导入excel 导入失败，文件中未找到密码数据"),f.error("导入失败，文件中未找到密码数据");return}const s={id:o.indexOf("id"),title:o.indexOf("名称"),address:o.indexOf("地址"),username:o.indexOf("用户名"),password:o.indexOf("密码"),remark:o.indexOf("备注"),addTime:o.indexOf("创建时间"),favorite:o.indexOf("收藏"),labels:o.indexOf("标签"),customFields:o.indexOf("自定义信息")};if(!s.title){console.log("导入excel 导入失败，未找到密码名称列"),f.error("导入失败，未找到密码名称列");return}console.log("导入excel 开始处理数据：",e.rowCount);for(let v=2;v<=e.rowCount;v++){const c=e.getRow(v);let k=c.getCell(s.title);if(!k){console.log("导入excel 密码标题不存在 第"+v+"行");continue}let n=s.id!==-1?c.getCell(s.id):null,d=s.address!==-1?c.getCell(s.address):null,x=s.username!==-1?c.getCell(s.username):null,h=s.password!==-1?c.getCell(s.password):null,b=s.remark!==-1?c.getCell(s.remark):null,F=s.addTime!==-1?c.getCell(s.addTime):null,O=s.labels!==-1?c.getCell(s.labels):null,z=s.favorite!==-1?c.getCell(s.favorite):null,R=s.customFields!==-1?c.getCell(s.customFields):null;d&&typeof d.value=="object"&&(d.value=d.value.text),x&&typeof x.value=="object"&&(x.value=x.value.text),h&&typeof h.value=="object"&&(h.value=h.value.text),b&&typeof b.value=="object"&&(b.value=b.value.text);let W=z&&z.value==="是",J=[];if(O&&O.value){console.log("导入excel 开始解析标签树");let E=be(O.value);console.log("导入excel 开始合并标签树"),Y(p.value,E),console.log("导入excel 设置密码标签ids"),N(E,J)}let ae=F&&F.value?_e(F.value,"YYYY-MM-DD HH:mm:ss"):new Date;const K={id:n?n.value:ye(),title:k?k.value:"",address:d?d.value:"",username:x?x.value:"",password:h?h.value:"",remark:b?b.value:"",addTime:ae.getTime(),updateTime:Date.now(),deleteTime:0,favoriteTime:W?Date.now():0,favorite:W,customFields:[],labels:J,status:U.NORMAL,bgColor:""};if(R&&R.value){let E=R.value.split(`\r
`);for(let M=0;M<E.length;M++){let I=E[M].split("：");K.customFields.push({key:I[0],val:I.length>1?I[1]:""})}}m.value.push(K)}console.log("导入excel 导入的数量,密码：",m.value.length," 标签",p.value.length),m.value.length||p.value.length?(y.value=!0,await Pe(()=>{console.log("导入excel 全选密码列表"),g.value.toggleAllSelection()})):f.warning("没有可导入的密码")},N=(a,l=[])=>(a.forEach(e=>{!e.children||e.children.length===0?l.push(e.id):N(e.children,l)}),l),Y=(a,l)=>{for(let e=0;e<l.length;e++){let t=l[e],o=a.find(s=>s.name===t.name);if(!o){a.push(t);continue}t.id=o.id,Y(o.children,t.children)}},le=()=>{if(console.log("导入excel 确认导入已选中密码与标签"),!g.value.getSelectionRows().length){console.log("导入excel 未选择密码"),pe.warning("请选择要导入的密码");return}console.log("导入excel 验证身份"),Q.verifyPasswordRef.getAndVerify(l=>u.passwordManager.verifyPassword(l)).then(()=>{console.log("导入excel 确认开始导入"),te()})},te=()=>{try{u.loading("正在导入...");const l=g.value.getSelectionRows().map(t=>t.id),e=m.value.filter(t=>l.includes(t.id));console.log("要导入的密码：",e),console.log("要导入的标签：",p.value),oe(u.allPasswordArray,e),A(u.labelArray,p.value),u.passwordManager.syncStoreData(),y.value=!1,m.value=[],p.value=[],u.unloading(),f.success("导入成功")}catch(a){console.error(a),u.unloading(),f.error("导入失败")}},oe=(a,l)=>{l.forEach(e=>{const t=a.find(o=>$(o,e));if(t){if(t.status=U.NORMAL,e.labels){const o=new Set(t.labels);e.labels.forEach(s=>{o.has(s)||t.labels.push(s)})}}else a.push(e)})},A=(a,l)=>{const e=new Map(a.map(t=>[t.name,t]));l.forEach(t=>{const o=e.get(t.name);o?(se(u.allPasswordArray,t.id,o.id),A(o.children,t.children)):(a.push(t),e.set(t.name,t))})},se=(a,l,e)=>{a.forEach(t=>{t.labels=t.labels.map(o=>o===l?e:o)})},j=a=>!u.passwordArray.find(l=>$(l,a)),H=()=>g.value?!g.value.getSelectionRows().length:!0;return G({importExcel:X}),(a,l)=>{const e=re,t=ie,o=ce,s=de,v=ne,c=ue,k=fe;return w(),L(B,null,[V("input",{ref_key:"fileInput",ref:T,accept:".xlsx",style:{display:"none"},type:"file",onChange:l[0]||(l[0]=n=>Z())},null,544),r(k,{modelValue:_(y),"onUpdate:modelValue":l[1]||(l[1]=n=>Te(y)?y.value=n:null),width:["xs","sm","md"].includes(_(he)().value)?"95%":"80%",title:"导入信息确认",top:"10vh"},{footer:i(()=>[r(t,{disabled:!H(),content:"请选择要导入的密码",placement:"top"},{default:i(()=>[r(c,{disabled:H(),type:"primary",onClick:le},{default:i(()=>[...l[4]||(l[4]=[S("确认导入",-1)])]),_:1},8,["disabled"])]),_:1},8,["disabled"])]),default:i(()=>[r(v,{ref_key:"passwordTableRef",ref:g,data:_(m),height:"65vh"},{default:i(()=>[r(e,{selectable:j,type:"selection",width:"55"}),r(e,{width:"55"},{default:i(n=>[j(n.row)?(w(),P(t,{key:0,content:"可导入",placement:"top"},{default:i(()=>[...l[2]||(l[2]=[V("span",{class:"iconfont icon-info",style:{color:"#409EFF","font-size":"16px"}},null,-1)])]),_:1})):(w(),P(t,{key:1,content:"已存在密码不可导入",placement:"top"},{default:i(()=>[...l[3]||(l[3]=[V("span",{class:"iconfont icon-info",style:{color:"#ff9600","font-size":"16px"}},null,-1)])]),_:1}))]),_:1}),r(e,{label:"名称","min-width":"100px",prop:"title"}),r(e,{label:"地址","min-width":"150px",prop:"address"}),r(e,{label:"用户名","min-width":"100px",prop:"username"}),r(e,{label:"密码",prop:"password",width:"180px"},{default:i(n=>[r(o,{"line-clamp":"3",truncated:""},{default:i(()=>[S(D(n.row.password),1)]),_:2},1024)]),_:1}),r(e,{formatter:n=>_(ve)(n.addTime,"YYYY-MM-DD HH:mm"),label:"创建时间","min-width":"150px",prop:"addTime"},null,8,["formatter"]),r(e,{label:"备注","min-width":"100px",prop:"remark"}),r(e,{label:"标签","min-width":"150px",prop:"labels"},{default:i(n=>[(w(!0),L(B,null,q(_(xe)(n.row,_(p)),d=>(w(),P(s,{class:"table-label"},{default:i(()=>[S(D(d.name),1)]),_:2},1024))),256))]),_:1}),r(e,{label:"自定义信息","min-width":"150px",prop:"customFields"},{default:i(n=>[(w(!0),L(B,null,q(n.row.customFields,d=>(w(),P(s,{class:"table-label"},{default:i(()=>[S(D(d.key)+"："+D(d.val),1)]),_:2},1024))),256))]),_:1})]),_:1},8,["data"])]),_:1},8,["modelValue","width"])],64)}}}),Ne=ke(Se,[["__scopeId","data-v-1a8a4730"]]);export{Ne as default};
