import{O as c}from"./ali-oss-B_Q55M9i.js";import{a4 as h}from"./vendor-B4nIbczL.js";import{H as u}from"./index-DZ5-n0Cs.js";import{E as a,a as g}from"./element-plus-DfJ8pmrs.js";import"./@vue-BhCi5Yj9.js";import"./cos-js-sdk-v5-B8_2Tx6c.js";import"./@element-plus-C1_C3qTM.js";class F{fileNames={store:"password-xl/store.json",setting:"password-xl/setting.json",note:"password-xl/note.json"};fileEtags={};ossClient=null;region=null;bucket=null;async login(e){try{return this.ossClient=new c({region:e.region,accessKeyId:e.accessKeyId,accessKeySecret:e.accessKeySecret,bucket:e.bucket,secure:!0}),this.region=e.region,this.bucket=e.bucket,Promise.resolve({status:!0})}catch(s){return Promise.reject({status:!1,message:s})}}async getStoreData(){return this.getFile(this.fileNames.store)}async setStoreData(e){return this.uploadFile(this.fileNames.store,e)}async getTreeNoteData(){return this.getFile(this.fileNames.note)}async setNoteData(e){return this.uploadFile(this.fileNames.note,e)}async getData(e){return this.getFile(e)}async setData(e,s){return this.uploadFile(e,s)}async deleteStoreData(){return this.deleteFile(this.fileNames.store)}async getSettingData(){return this.getFile(this.fileNames.setting)}async setSettingData(e){return this.uploadFile(this.fileNames.setting,e)}async deleteSettingData(){return this.deleteFile(this.fileNames.setting)}async deleteData(e){return this.deleteFile(e)}async uploadImage(e,s){return new Promise((o,t)=>{if(!this.ossClient)throw new Error("oss uploadFile 存储引擎不存在");let l=e.name.split(".").pop(),i="/images/"+s+"/"+u()+"."+l;const r={"x-oss-object-acl":"public-read"};this.ossClient.put(i,e,{headers:r}).then(async()=>{console.log("上传oss图片成功：",i),console.log("this.region",this.region),console.log("this.bucket",this.bucket),o("https://"+this.bucket+"."+this.region+".aliyuncs.com"+i)}).catch(n=>{console.error("oss上传文件错误：",n),a.error({title:"系统异常",message:this.errorDispose(n)}),t({status:!1,message:this.errorDispose(n)})})})}async getFile(e){return console.log("获取oss文件：",e),new Promise((s,o)=>{if(!this.ossClient)throw new Error("oss getFile 存储引擎不存在");this.ossClient.get(e).then(t=>{this.updateEtag(e,JSON.parse(JSON.stringify(t.res.headers))["last-modified"]),s(t.content.toString())}).catch(t=>{t&&t.status===404?s(""):(a.error({title:"系统异常",message:this.errorDispose(t)}),o({status:!1,message:this.errorDispose(t)}))})})}async uploadFile(e,s){return console.log("上传oss文件：",e,"length:",s.length),new Promise(async(o,t)=>{if(!this.ossClient)throw new Error("oss uploadFile 存储引擎不存在");if(!await this.checkEtag(e)){console.log("上传oss文件 文件同步异常"),g({title:"文件同步异常",message:"当前密码列表已被其他客户端更新，请刷新页面",showCancelButton:!1,showConfirmButton:!0,closeOnPressEscape:!1,showClose:!1,closeOnClickModal:!1,confirmButtonText:"刷新",callback:()=>{console.log("刷新"),location.reload()}});return}let i=h.Buffer.from(s);this.ossClient.put(e,i).then(async()=>{await this.updateEtag(e),o({status:!0})}).catch(r=>{console.error("oss上传文件错误：",r),a.error({title:"系统异常",message:this.errorDispose(r)}),t({status:!1,message:this.errorDispose(r)})})})}async deleteFile(e){return console.log("删除oss文件：",e),new Promise((s,o)=>{if(!this.ossClient)throw new Error("oss deleteFile 存储引擎不存在");this.ossClient.delete(e).then(()=>{s({status:!0})}).catch(t=>{console.error(t),a.error({title:"系统异常",message:this.errorDispose(t)}),o({status:!1,message:this.errorDispose(t)})})})}errorDispose(e){let s={InvalidAccessKeyId:"账号（AccessKeyId）无效",SignatureDoesNotMatch:"密钥（secretKey）无效",AccessDenied:"该账号无存储桶（bucket）权限或存储桶错误"};if(e.status===-1)return console.error("存储桶访问异常：",e),"有可能是存储桶（bucket）不存在、地域（region）错误、跨域配置错误";if(e.status===403){let o=s[e.code];return o||"权限错误"}else return e.message}getEtag(e){return new Promise(async s=>{if(!this.ossClient)throw new Error("oss getEtag 存储引擎不存在");let o=await this.ossClient.head(e),t=JSON.parse(JSON.stringify(o.res.headers))["last-modified"];s(t)})}async checkEtag(e){if(!this.fileEtags[e])return Promise.resolve(!0);let s=await this.getEtag(e);return this.fileEtags[e]===s}async updateEtag(e,s){s||(s=await this.getEtag(e)),this.fileEtags[e]=s}}export{F as DatabaseForOSS};
