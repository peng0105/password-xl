import{M as X,I as Z,c as O,J as ee,K as te,a as oe,b as K,O as j,v as ne,S as ae,e as Y,u as se,P as le,T as re,U as ie,V as de}from"./element-plus-DfJ8pmrs.js";import{a as F,G as q,u as G,H as ce,_ as U,I as ue}from"./index-DZ5-n0Cs.js";import{d as z,r as m,H as P,M as H,c as pe,z as V,u as c,D as r,v as a,a as h,Q as fe,B as N,C as Q,o as $,K as me,R as _e,n as J,x as L,ak as ge}from"./@vue-BhCi5Yj9.js";import{_ as ve}from"./logo-B_J9w6Yt.js";import{I as ye}from"./aieditor-CfOwAmUy.js";import{a2 as he}from"./vendor-B4nIbczL.js";import"./@element-plus-C1_C3qTM.js";import"./cos-js-sdk-v5-B8_2Tx6c.js";import"./ali-oss-B_Q55M9i.js";const xe={key:0,class:"note-tree"},we=["onContextmenu"],Ne=z({__name:"NoteTree",emits:["activateChange"],setup(A,{expose:k,emit:D}){const g=F(),i=q(),p=m({}),v=G(),_=m(),d=m(!0),o=D,f=m([]),S=t=>{let e={id:ce(),label:"新笔记",children:[]};t?(t.children||(t.children=[]),t.children.push(e)):i.noteData.noteTree.push(e),H(()=>{_.value.setCurrentKey(e.id+""),i.noteData.currentNote=e.id+"",g.noteTitleRef&&g.noteTitleRef.value&&g.noteTitleRef.focus(),v.passwordManager.syncNoteData()})},x=t=>{let e="确认删除“"+t.data.label+"”吗？";t.children&&t.children.length&&(e="确认删除“"+t.data.label+"”及其子目录下的所有笔记吗？"),oe.confirm(e,"删除笔记",{confirmButtonText:"删除",cancelButtonText:"取消",type:"warning"}).then(()=>{b(t)}).catch(()=>{})},C=t=>{const e=(u,B)=>{B.push(u.id);for(let T=0;T<u.children.length;T++)e(u.children[T],B)};let n=[];return e(t.data,n),n},E=(t,e)=>{for(let n=e.length-1;n>=0;n--)e[n].children&&E(t,e[n].children),t.includes(e[n].id)&&(console.log("删除笔记",e[n].id),e.splice(n,1))},b=t=>{let e=C(t);for(let n=0;n<e.length;n++){let u="note/"+e[n]+".html";v.passwordManager.delData(u),y(e[n])}E(e,i.noteData.noteTree),i.noteData.currentNote&&e.includes(i.noteData.currentNote)&&(i.noteData.currentNote=""),v.passwordManager.syncNoteData(),K.success("删除成功")},l=(t,e)=>{t.stopPropagation();for(let n in p.value)p.value[n]&&p.value[n].handleClose()},s=t=>{i.noteData.currentNote!==t.id&&(i.noteData.currentNote=t.id,o("activateChange",t),v.passwordManager.syncNoteData())},w=t=>{f.value.push(t),localStorage.setItem("expandKeys",JSON.stringify(f.value))},y=t=>{f.value=f.value.filter(e=>e!==t),localStorage.setItem("expandKeys",JSON.stringify(f.value))};return P(()=>{f.value=JSON.parse(localStorage.getItem("expandKeys")||"[]"),d.value=!1,H(()=>{if(i.noteData.currentNote){_.value.setCurrentKey(i.noteData.currentNote);let t=_.value.getCurrentNode();t&&o("activateChange",t)}})}),k({addNote:S}),(t,e)=>{const n=O,u=te,B=ee,T=Z,W=X;return c(d)?V("",!0):($(),pe("div",xe,[r(W,{ref_key:"treeRef",ref:_,data:c(i).noteData.noteTree,"default-expanded-keys":c(f),"expand-on-click-node":!1,draggable:"","highlight-current":"","node-key":"id",style:{"max-width":"600px"},onNodeExpand:e[0]||(e[0]=M=>w(M.id)),onNodeCollapse:e[1]||(e[1]=M=>y(M.id)),onCurrentChange:s,onNodeDrop:e[2]||(e[2]=()=>c(v).passwordManager.syncNoteData())},{default:a(({node:M,data:I})=>[r(T,{ref:R=>c(p)[I.id]=R,style:{width:"100%"},trigger:"contextmenu"},{dropdown:a(()=>[r(B,{style:{width:"100px"}},{default:a(()=>[r(u,{onClick:R=>S(I)},{default:a(()=>[...e[3]||(e[3]=[h("span",{class:"iconfont icon-create more-item",style:{color:"rgb(0 147 255)"}},null,-1),N(" 新笔记 ",-1)])]),_:1},8,["onClick"]),r(u,{onClick:R=>x(M)},{default:a(()=>[...e[4]||(e[4]=[h("span",{class:"iconfont icon-delete more-item",style:{color:"rgb(255,23,23)","font-size":"130%"}},null,-1),N(" 删除 ",-1)])]),_:1},8,["onClick"])]),_:2},1024)]),default:a(()=>[h("div",{class:"node-class",onContextmenu:R=>l(R,I.id)},[r(n,{style:fe([{color:c(i).noteData.currentNote===I.id?"#409EFF":""},{width:"85%"}]),truncated:""},{default:a(()=>[N(Q(I.label),1)]),_:2},1032,["style"])],40,we)]),_:2},1536)]),_:1},8,["data","default-expanded-keys"])]))}}}),De=U(Ne,[["__scopeId","data-v-14384c68"]]),Ce={style:{display:"flex","justify-content":"space-between"}},ke=z({__name:"NoteEditor",setup(A,{expose:k}){const D=F(),g=m(!0),i=m(),p=m(""),v=q(),_=G();let d=null;const o=m({id:"",name:"",content:"",updateTime:0});function f(l){l.preventDefault(),l.returnValue=""}const S=l=>{o.value.id&&(x(),p.value=""),g.value=!0,_.passwordManager.getData("note/"+l.id+".html").then(s=>{s?o.value=JSON.parse(s):o.value={id:l.id,name:l.label,content:"",updateTime:Date.now()},p.value=JSON.stringify(o.value),E(o.value.content),g.value=!1})},x=(l=!1)=>{if(o.value.id){if(!o.value.name){K.error("请输入标题");return}if(p.value===JSON.stringify(o.value)){l&&K.success("保存成功");return}o.value.updateTime=Date.now(),p.value=JSON.stringify(o.value),_.passwordManager.setData("note/"+o.value.id+".html",p.value).then(()=>{l&&K.success("保存成功");let s=v.getTreeNoteById(o.value.id);s&&(s.label=o.value.name,_.passwordManager.syncNoteData()),window.removeEventListener("beforeunload",f)})}},C=m(),E=l=>{d&&d.destroy(),d=new ye({element:i.value,toolbarKeys:["brush","eraser","|","heading","font-family","font-size","|","bold","italic","underline","strike","link","code","subscript","superscript","hr","todo","emoji","|","image","highlight","font-color","|","align","line-height","bullet-list","ordered-list","|","quote","code-block","container","table","source-code"],textSelectionBubbleMenu:{enable:!0,items:["Bold","Italic","Underline","Strike","code","comment"]},image:{uploader:s=>new Promise(w=>{_.passwordManager.uploadImage(s,o.value.id).then(y=>{console.log("上传data",y),w({errorCode:0,data:{src:y,alt:s.name}})}).catch(y=>{console.log("图片上传失败",y),w({errorCode:-1})})})},placeholder:"点击输入内容...",content:l,onChange:s=>{o.value.content=s.getHtml(),window.addEventListener("beforeunload",f),C.value&&clearTimeout(C.value),C.value=setTimeout(()=>{x()},500)}})},b=l=>{l.ctrlKey&&l.key.toUpperCase()==="S"&&(console.log("使用快捷键 Ctrl + S"),l.preventDefault(),x(!0))};return me(()=>{d&&d.destroy()}),P(()=>{document.addEventListener("keydown",b)}),_e(()=>{document.removeEventListener("keydown",b)}),k({showNote:S}),(l,s)=>{const w=O,y=Y,t=ae,e=j,n=ne;return c(v).noteData.currentNote?($(),J(e,{key:0,class:"editor-card",shadow:"never",style:{height:"calc(100% - 2px)"}},{header:a(()=>[h("div",Ce,[L(h("input",{ref:u=>c(D).noteTitleRef=u,"onUpdate:modelValue":s[0]||(s[0]=u=>c(o).name=u),class:"title-input",placeholder:"请输入标题"},null,512),[[ge,c(o).name]]),r(w,null,{default:a(()=>[N("最后更新于："+Q(c(he)(c(o).updateTime).format("YYYY-MM-DD HH:mm:ss")),1)]),_:1}),r(t,{size:"large"},{default:a(()=>[r(y,{plain:"",size:"small",type:"primary",onClick:s[1]||(s[1]=u=>x(!0))},{default:a(()=>[...s[2]||(s[2]=[N("保存",-1)])]),_:1})]),_:1})])]),default:a(()=>[L(h("div",{ref_key:"editorRef",ref:i,"element-loading-text":"加载中，别急",style:{height:"calc(100vh - 66px)"}},null,512),[[n,c(g)]])]),_:1})):V("",!0)}}}),Se=U(ke,[["__scopeId","data-v-ee6ae420"]]),Ee={style:{height:"calc(100% - 2px)",display:"flex","flex-direction":"column"}},be={style:{display:"flex","justify-content":"space-between"}},Te={style:{display:"flex","align-items":"center"}},Me=z({__name:"NotePage",setup(A){const k=m(),D=m(!1),g=m(),i=()=>{ue.push("/")},p=d=>{k.value.addNote(d)},v=d=>{g.value.showNote(d)},_=()=>{D.value=!1,localStorage.setItem("firstNote","1")};return P(()=>{localStorage.getItem("firstNote")||(D.value=!0)}),(d,o)=>{const f=se,S=O,x=le,C=Y,E=De,b=j,l=re,s=ie,w=de;return $(),J(w,{class:"note-container"},{default:a(()=>[r(l,{class:"mask",style:{"margin-right":"6px"},width:"310px"},{default:a(()=>[h("div",Ee,[c(D)?($(),J(f,{key:0,style:{"margin-bottom":"12px"},type:"warning",onClose:_},{default:a(()=>[...o[1]||(o[1]=[N(" 笔记内容未使用主密码加密，请注意安全 ",-1)])]),_:1})):V("",!0),r(b,{shadow:"never",style:{width:"calc(100% - 2px)",flex:"1"}},{header:a(()=>[h("div",be,[r(S,{style:{"font-size":"18px",color:"#444"}},{default:a(()=>[...o[2]||(o[2]=[N("目录",-1)])]),_:1}),h("div",Te,[r(x,{content:"密码管理"},{default:a(()=>[h("img",{alt:"",src:ve,style:{height:"30px","margin-right":"10px",cursor:"pointer"},onClick:i})]),_:1}),r(x,{content:"添加笔记"},{default:a(()=>[r(C,{circle:"",class:"note-btn",plain:"",type:"primary",onClick:o[0]||(o[0]=y=>p())},{default:a(()=>[...o[3]||(o[3]=[N(" + ",-1)])]),_:1})]),_:1})])])]),default:a(()=>[r(E,{ref_key:"noteTreeRef",ref:k,onActivateChange:v},null,512)]),_:1})])]),_:1}),r(s,{class:"mask",style:{"margin-left":"6px"}},{default:a(()=>[r(Se,{ref_key:"noteEditorRef",ref:g},null,512)]),_:1})]),_:1})}}}),Pe=U(Me,[["__scopeId","data-v-8c7e08dc"]]);export{Pe as default};
