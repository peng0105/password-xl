import{O as c}from"./ali-oss-CN0NZiD5.js";import{a4 as h}from"./vendor-BvEI7uIN.js";import{H as u}from"./index-DYm6R2xW.js";import{E as o,a as g}from"./element-plus-DUvDCZNl.js";import"./@vue-PmY8Mkr0.js";import"./cos-js-sdk-v5-WX9VGj_f.js";import"./@element-plus-CuK1irWX.js";class F{fileNames={store:"password-xl/store.json",setting:"password-xl/setting.json",note:"password-xl/note.json"};fileEtags={};ossClient=null;region=null;bucket=null;async login(e){try{return this.ossClient=new c({region:e.region,accessKeyId:e.accessKeyId,accessKeySecret:e.accessKeySecret,bucket:e.bucket,secure:!0}),this.region=e.region,this.bucket=e.bucket,Promise.resolve({status:!0})}catch(t){return Promise.reject({status:!1,message:t})}}async getStoreData(){return this.getFile(this.fileNames.store)}async setStoreData(e){return this.uploadFile(this.fileNames.store,e)}async getTreeNoteData(){return this.getFile(this.fileNames.note)}async setNoteData(e){return this.uploadFile(this.fileNames.note,e)}async getData(e){return this.getFile(e)}async setData(e,t){return this.uploadFile(e,t)}async deleteStoreData(){return this.deleteFile(this.fileNames.store)}async getSettingData(){return this.getFile(this.fileNames.setting)}async setSettingData(e){return this.uploadFile(this.fileNames.setting,e)}async deleteSettingData(){return this.deleteFile(this.fileNames.setting)}async deleteData(e){return this.deleteFile(e)}async uploadImage(e,t){return new Promise((i,s)=>{if(!this.ossClient)throw new Error("oss uploadFile 存储引擎不存在");let n=e.name.split(".").pop(),a="/images/"+t+"/"+u()+"."+n;const r={"x-oss-object-acl":"public-read"};this.ossClient.put(a,e,{headers:r}).then(async()=>{i("https://"+this.bucket+"."+this.region+".aliyuncs.com"+a)}).catch(l=>{o.error({title:"系统异常",message:this.errorDispose(l)}),s({status:!1,message:this.errorDispose(l)})})})}async getFile(e){return new Promise((t,i)=>{if(!this.ossClient)throw new Error("oss getFile 存储引擎不存在");this.ossClient.get(e).then(s=>{this.updateEtag(e,JSON.parse(JSON.stringify(s.res.headers))["last-modified"]),t(s.content.toString())}).catch(s=>{s&&s.status===404?t(""):(o.error({title:"系统异常",message:this.errorDispose(s)}),i({status:!1,message:this.errorDispose(s)}))})})}async uploadFile(e,t){return new Promise(async(i,s)=>{if(!this.ossClient)throw new Error("oss uploadFile 存储引擎不存在");if(!await this.checkEtag(e)){g({title:"文件同步异常",message:"当前密码列表已被其他客户端更新，请刷新页面",showCancelButton:!1,showConfirmButton:!0,closeOnPressEscape:!1,showClose:!1,closeOnClickModal:!1,confirmButtonText:"刷新",callback:()=>{location.reload()}});return}let a=h.Buffer.from(t);this.ossClient.put(e,a).then(async()=>{await this.updateEtag(e),i({status:!0})}).catch(r=>{o.error({title:"系统异常",message:this.errorDispose(r)}),s({status:!1,message:this.errorDispose(r)})})})}async deleteFile(e){return new Promise((t,i)=>{if(!this.ossClient)throw new Error("oss deleteFile 存储引擎不存在");this.ossClient.delete(e).then(()=>{t({status:!0})}).catch(s=>{o.error({title:"系统异常",message:this.errorDispose(s)}),i({status:!1,message:this.errorDispose(s)})})})}errorDispose(e){let t={InvalidAccessKeyId:"账号（AccessKeyId）无效",SignatureDoesNotMatch:"密钥（secretKey）无效",AccessDenied:"该账号无存储桶（bucket）权限或存储桶错误"};if(e.status===-1)return"有可能是存储桶（bucket）不存在、地域（region）错误、跨域配置错误";if(e.status===403){let i=t[e.code];return i||"权限错误"}else return e.message}getEtag(e){return new Promise(async t=>{if(!this.ossClient)throw new Error("oss getEtag 存储引擎不存在");let i=await this.ossClient.head(e),s=JSON.parse(JSON.stringify(i.res.headers))["last-modified"];t(s)})}async checkEtag(e){if(!this.fileEtags[e])return Promise.resolve(!0);let t=await this.getEtag(e);return this.fileEtags[e]===t}async updateEtag(e,t){t||(t=await this.getEtag(e)),this.fileEtags[e]=t}}export{F as DatabaseForOSS};
