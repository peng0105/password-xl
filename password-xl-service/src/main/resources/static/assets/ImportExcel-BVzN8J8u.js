import{k as ne,l as re,m as ie,c as ce,x as de,e as ue,f as fe,E as f,b as pe}from"./element-plus-BZLLPOmQ.js";import{E as me}from"./exceljs-eb77zzzs.js";import{u as ge,a as we,p as xe,B as ve,d as he,R as be,U as _e,P as $,i as ye,c as q,_ as ke}from"./index-HOZrobza.js";import{a4 as Ee}from"./vendor-B4nIbczL.js";import{d as Ce,r as C,c as B,o as g,a as L,D as r,v as i,u as _,n as P,B as S,C as D,F as V,a1 as G,j as Te,M as Pe}from"./@vue-BhCi5Yj9.js";import"./@element-plus-C1_C3qTM.js";import"./ali-oss-B_Q55M9i.js";import"./cos-js-sdk-v5-B8_2Tx6c.js";const Se=Ce({__name:"ImportExcel",setup(De,{expose:K}){const u=ge(),Q=we(),T=C(),w=C(),y=C(!1),m=C([]),p=C([]),X=async()=>{console.log("进入导入excel"),m.value=[],p.value=[],T.value.value="",T.value.click()},Z=()=>{let a=T.value.files;if(console.log("导入excel,文件选择器选择了文件：",a.length),!a.length)return;const l=new FileReader;l.onload=()=>{console.log("导入excel,文件读取完成");const e=Ee.Buffer.from(l.result);try{ee(e)}catch(t){console.error("导入excel 导入错误",t),f.error("密码导入失败")}},l.onerror=e=>{console.error("导入excel 读取错误",e),f.error("读取文件失败")},l.readAsArrayBuffer(a[0])},ee=async a=>{console.log("导入excel 解析excel");const l=new me.Workbook;await l.xlsx.load(a);const e=l.getWorksheet(1);if(!e){console.log("导入excel 导入失败，没有找到Sheet页"),f.error("导入失败，没有找到Sheet页");return}let t=e.getRow(1);if(!t){console.log("导入excel 导入失败，文件中未找到密码数据"),f.error("导入失败，文件中未找到密码数据");return}const o=t.values;if(console.log("first row values:",o),!o||e.rowCount<2){console.log("导入excel 导入失败，文件中未找到密码数据"),f.error("导入失败，文件中未找到密码数据");return}const s={id:o.indexOf("id"),title:o.indexOf("名称"),address:o.indexOf("地址"),username:o.indexOf("用户名"),password:o.indexOf("密码"),remark:o.indexOf("备注"),addTime:o.indexOf("创建时间"),favorite:o.indexOf("收藏"),labels:o.indexOf("标签"),customFields:o.indexOf("自定义信息")};if(!s.title){console.log("导入excel 导入失败，未找到密码名称列"),f.error("导入失败，未找到密码名称列");return}console.log("导入excel 开始处理数据：",e.rowCount);for(let x=2;x<=e.rowCount;x++){const c=e.getRow(x);let k=c.getCell(s.title);if(!k){console.log("导入excel 密码标题不存在 第"+x+"行");continue}let n=s.id!==-1?c.getCell(s.id):null,d=s.address!==-1?c.getCell(s.address):null,v=s.username!==-1?c.getCell(s.username):null,h=s.password!==-1?c.getCell(s.password):null,b=s.remark!==-1?c.getCell(s.remark):null,R=s.addTime!==-1?c.getCell(s.addTime):null,F=s.labels!==-1?c.getCell(s.labels):null,z=s.favorite!==-1?c.getCell(s.favorite):null,M=s.customFields!==-1?c.getCell(s.customFields):null;d&&typeof d.value=="object"&&(d.value=d.value.text),v&&typeof v.value=="object"&&(v.value=v.value.text),h&&typeof h.value=="object"&&(h.value=h.value.text),b&&typeof b.value=="object"&&(b.value=b.value.text);let U=z&&z.value==="是",W=[];if(F&&F.value){console.log("导入excel 开始解析标签树");let E=be(F.value);console.log("导入excel 开始合并标签树"),A(p.value,E),console.log("导入excel 设置密码标签ids"),Y(E,W)}let ae=R&&R.value?_e(R.value,"YYYY-MM-DD HH:mm:ss"):new Date;const J={id:n?n.value:ye(),title:k?k.value:"",address:d?d.value:"",username:v?v.value:"",password:h?h.value:"",remark:b?b.value:"",addTime:ae.getTime(),updateTime:Date.now(),deleteTime:0,favoriteTime:U?Date.now():0,favorite:U,customFields:[],labels:W,status:$.NORMAL,bgColor:""};if(M&&M.value){let E=M.value.split(`\r
`);for(let O=0;O<E.length;O++){let I=E[O].split("：");J.customFields.push({key:I[0],val:I.length>1?I[1]:"",hidden:!1})}}m.value.push(J)}console.log("导入excel 导入的数量,密码：",m.value.length," 标签",p.value.length),m.value.length||p.value.length?(y.value=!0,await Pe(()=>{console.log("导入excel 全选密码列表"),w.value.toggleAllSelection()})):f.warning("没有可导入的密码")},Y=(a,l=[])=>(a.forEach(e=>{!e.children||e.children.length===0?l.push(e.id):Y(e.children,l)}),l),A=(a,l)=>{for(let e=0;e<l.length;e++){let t=l[e],o=a.find(s=>s.name===t.name);if(!o){a.push(t);continue}t.id=o.id,A(o.children,t.children)}},le=()=>{if(console.log("导入excel 确认导入已选中密码与标签"),!w.value.getSelectionRows().length){console.log("导入excel 未选择密码"),pe.warning("请选择要导入的密码");return}console.log("导入excel 验证身份"),Q.verifyPasswordRef.getAndVerify(l=>u.passwordManager.verifyPassword(l)).then(()=>{console.log("导入excel 确认开始导入"),te()})},te=()=>{try{u.loading("正在导入...");const l=w.value.getSelectionRows().map(t=>t.id),e=m.value.filter(t=>l.includes(t.id));console.log("要导入的密码：",e),console.log("要导入的标签：",p.value),oe(u.allPasswordArray,e),N(u.labelArray,p.value),u.passwordManager.syncStoreData(),y.value=!1,m.value=[],p.value=[],u.unloading(),f.success("导入成功")}catch(a){console.error(a),u.unloading(),f.error("导入失败")}},oe=(a,l)=>{l.forEach(e=>{const t=a.find(o=>q(o,e));if(t){if(t.status=$.NORMAL,e.labels){const o=new Set(t.labels);e.labels.forEach(s=>{o.has(s)||t.labels.push(s)})}}else a.push(e)})},N=(a,l)=>{const e=new Map(a.map(t=>[t.name,t]));l.forEach(t=>{const o=e.get(t.name);o?(se(u.allPasswordArray,t.id,o.id),N(o.children,t.children)):(a.push(t),e.set(t.name,t))})},se=(a,l,e)=>{a.forEach(t=>{t.labels=t.labels.map(o=>o===l?e:o)})},j=a=>!u.passwordArray.find(l=>q(l,a)),H=()=>w.value?!w.value.getSelectionRows().length:!0;return K({importExcel:X}),(a,l)=>{const e=re,t=ie,o=ce,s=de,x=ne,c=ue,k=fe;return g(),B(V,null,[L("input",{ref_key:"fileInput",ref:T,accept:".xlsx",style:{display:"none"},type:"file",onChange:l[0]||(l[0]=n=>Z())},null,544),r(k,{modelValue:_(y),"onUpdate:modelValue":l[1]||(l[1]=n=>Te(y)?y.value=n:null),width:["xs","sm","md"].includes(_(he)().value)?"95%":"80%",title:"导入信息确认",top:"10vh"},{footer:i(()=>[r(t,{disabled:!H(),content:"请选择要导入的密码",placement:"top"},{default:i(()=>[r(c,{disabled:H(),type:"primary",onClick:le},{default:i(()=>[...l[4]||(l[4]=[S("确认导入",-1)])]),_:1},8,["disabled"])]),_:1},8,["disabled"])]),default:i(()=>[r(x,{ref_key:"passwordTableRef",ref:w,data:_(m),height:"65vh"},{default:i(()=>[r(e,{selectable:j,type:"selection",width:"55"}),r(e,{width:"55"},{default:i(n=>[j(n.row)?(g(),P(t,{key:0,content:"可导入",placement:"top"},{default:i(()=>[...l[2]||(l[2]=[L("span",{class:"iconfont icon-info",style:{color:"#409EFF","font-size":"16px"}},null,-1)])]),_:1})):(g(),P(t,{key:1,content:"已存在密码不可导入",placement:"top"},{default:i(()=>[...l[3]||(l[3]=[L("span",{class:"iconfont icon-info",style:{color:"#ff9600","font-size":"16px"}},null,-1)])]),_:1}))]),_:1}),r(e,{label:"名称","min-width":"100px",prop:"title"}),r(e,{label:"地址","min-width":"150px",prop:"address"}),r(e,{label:"用户名","min-width":"100px",prop:"username"}),r(e,{label:"密码",prop:"password",width:"180px"},{default:i(n=>[r(o,{"line-clamp":"3",truncated:""},{default:i(()=>[S(D(n.row.password),1)]),_:2},1024)]),_:1}),r(e,{formatter:n=>_(xe)(n.addTime,"YYYY-MM-DD HH:mm"),label:"创建时间","min-width":"150px",prop:"addTime"},null,8,["formatter"]),r(e,{label:"备注","min-width":"100px",prop:"remark"}),r(e,{label:"标签","min-width":"150px",prop:"labels"},{default:i(n=>[(g(!0),B(V,null,G(_(ve)(n.row,_(p)),d=>(g(),P(s,{class:"table-label"},{default:i(()=>[S(D(d.name),1)]),_:2},1024))),256))]),_:1}),r(e,{label:"自定义信息","min-width":"150px",prop:"customFields"},{default:i(n=>[(g(!0),B(V,null,G(n.row.customFields,d=>(g(),P(s,{class:"table-label"},{default:i(()=>[S(D(d.key)+"："+D(d.val),1)]),_:2},1024))),256))]),_:1})]),_:1},8,["data"])]),_:1},8,["modelValue","width"])],64)}}}),Ye=ke(Se,[["__scopeId","data-v-69209ebb"]]);export{Ye as default};
